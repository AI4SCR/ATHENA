

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Tutorial - SpatialOmics &mdash; athena  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Overview" href="../api_overview.html" />
    <link rel="prev" title="Tutorial on Imaging Mass Cytometry data" href="tutorial.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> athena
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Gallery</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview of ATHENA</a></li>
<li class="toctree-l1"><a class="reference internal" href="methodology.html">Methodology</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">SpatialOmics Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#load-from-raw-data">Load from Raw Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#download-example-images">Download Example Images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#populate-spatialomics-instance">Populate SpatialOmics Instance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#meta-data">Meta data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-image-data">Add image data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#visualise">Visualise</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#visualise-raw-data">Visualise Raw Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualise-data-with-athena">Visualise Data with Athena</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#extract-single-cell-expression-values">Extract Single-Cell Expression Values</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#load-pre-processed-spatialomics">Load Pre-processed SpatialOmics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-pre-processed-anndata-datasets">Load Pre-processed AnnData-Datasets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#imc-data">IMC Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fish-dataset">Fish Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visium-fluorescence-data">Visium Fluorescence Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visium-fluorescence-data-alternative-processing-based-on-image-segmentation">Visium Fluorescence Data - Alternative Processing based on Image Segmentation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#load-data">Load Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#analyse-image-segmentation">Analyse Image Segmentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extraction-of-image-features-for-each-segmentation-mask">Extraction of Image Features for each Segmentation Mask</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_overview.html">API Overview</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">athena</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Tutorial - SpatialOmics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/source/introduction-spatialOmics.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorial-spatialomics">
<h1>Tutorial - SpatialOmics<a class="headerlink" href="#tutorial-spatialomics" title="Permalink to this headline">¶</a></h1>
<p>Spatial omics technologies are an emergent field and currently no standard libraries or data structures exists for handling the generated data in a consistent way. To facilitate the development of this framework we introduce the <em>SpatialOmics</em> class. Since we work with high-dimensional images, memory complexity is a problem. <em>SpatialOmics</em> stores data in a HDF5 file and lazily loads the required images on the fly to keep the memory consumption low.
The design of this class is inspred by <em>AnnData</em>, a class developed for the analysis of single-cell data sets.</p>
<p><strong>Objective</strong></p>
<ul class="simple">
<li><p>Data standard for consistent method development</p></li>
<li><p>Technology-agnostic (resolutions, multiplexing and modalities )</p></li>
</ul>
<p><strong>Attributes</strong></p>
<ul class="simple">
<li><p><strong>X</strong>: Single-cell expression values (observations)</p></li>
<li><p><strong>var</strong>: Annotation of features in X</p></li>
<li><p><strong>obs</strong>: Annotation of observations</p></li>
<li><p><strong>spl</strong>: Annotation of samples</p></li>
<li><p><strong>G</strong>: Graph representation of observations</p></li>
<li><p><strong>images</strong>: Raw images</p></li>
<li><p><strong>masks</strong>: Segmentation masks</p></li>
<li><p><strong>uns</strong>: Unstructured data</p></li>
</ul>
<p><img alt="spatialOmics.png" src="../_images/spatialOmics.png" /></p>
<!-- **Data hierarchy**

- Sample-level information: patient features, acquisition details
- Observation-level information: expression levels, coordinates, phenotyping
![sample.png](img/sample.png) -->
<div class="section" id="load-from-raw-data">
<h2>Load from Raw Data<a class="headerlink" href="#load-from-raw-data" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">spatialOmics</span> <span class="kn">import</span> <span class="n">SpatialOmics</span>

<span class="c1"># create empty instance</span>
<span class="n">so</span> <span class="o">=</span> <span class="n">SpatialOmics</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="download-example-images">
<h3>Download Example Images<a class="headerlink" href="#download-example-images" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">tarfile</span>

<span class="c1"># url from which we download example images</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://ndownloader.figshare.com/files/29006556&#39;</span>
<span class="n">filehandle</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="populate-spatialomics-instance">
<h3>Populate SpatialOmics Instance<a class="headerlink" href="#populate-spatialomics-instance" title="Permalink to this headline">¶</a></h3>
<div class="section" id="meta-data">
<h4>Meta data<a class="headerlink" href="#meta-data" title="Permalink to this headline">¶</a></h4>
<p>The downloaded meta data contains information about all the patients in the study. We only select the patient information of the relevant image.</p>
</div>
<div class="section" id="add-image-data">
<h4>Add image data<a class="headerlink" href="#add-image-data" title="Permalink to this headline">¶</a></h4>
<p>We use the add_image and add_mask function to add the image and cellmask data to the SpatialOmics instance. We can set to_store to True to save images in a HDF5 file on the disk.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract images from tar archive</span>
<span class="n">fimg</span> <span class="o">=</span> <span class="s1">&#39;BaselTMA_SP41_15.475kx12.665ky_10000x8500_5_20170905_122_166_X15Y4_231_a0_full.tiff&#39;</span>
<span class="n">fmask</span> <span class="o">=</span> <span class="s1">&#39;BaselTMA_SP41_15.475kx12.665ky_10000x8500_5_20170905_122_166_X15Y4_231_a0_full_maks.tiff&#39;</span>
<span class="n">fmeta</span> <span class="o">=</span> <span class="s1">&#39;meta_data.csv&#39;</span>
<span class="n">root</span> <span class="o">=</span> <span class="s1">&#39;spatialOmics-tutorial&#39;</span>

<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filehandle</span><span class="p">,</span> <span class="s1">&#39;r:gz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
        
        <span class="n">img</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">fimg</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">fmask</span><span class="p">))</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">fmeta</span><span class="p">))</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;core&#39;</span><span class="p">)</span>
        
        <span class="c1"># set sample data of spatialOmics</span>
        <span class="n">so</span><span class="o">.</span><span class="n">spl</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">meta</span><span class="o">.</span><span class="n">filename_fullstack</span> <span class="o">==</span> <span class="n">fimg</span><span class="p">]</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">spl</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># add high-dimensional tiff image</span>
        <span class="n">so</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">fimg</span><span class="p">),</span> <span class="n">to_store</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># add segmentation mask</span>
        <span class="n">so</span><span class="o">.</span><span class="n">add_mask</span><span class="p">(</span><span class="n">spl</span><span class="p">,</span> <span class="s1">&#39;cellmasks&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">fmask</span><span class="p">),</span> <span class="n">to_store</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="visualise">
<h3>Visualise<a class="headerlink" href="#visualise" title="Permalink to this headline">¶</a></h3>
<div class="section" id="visualise-raw-data">
<h4>Visualise Raw Data<a class="headerlink" href="#visualise-raw-data" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualise example img and cellmask</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">15</span><span class="p">,])</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7fa7d14946d0&gt;
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_10_1.png" /></p>
</div>
<div class="section" id="visualise-data-with-athena">
<h4>Visualise Data with Athena<a class="headerlink" href="#visualise-data-with-athena" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">athena</span> <span class="k">as</span> <span class="nn">ath</span>

<span class="c1"># extract centroids of observations</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">extract_centroids</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">so</span><span class="o">.</span><span class="n">spl</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask_key</span><span class="o">=</span><span class="s1">&#39;cellmasks&#39;</span><span class="p">)</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/Users/art/Documents/projects/athena/athena/plotting/visualization.py:217: UserWarning: Matplotlib is currently using module://matplotlib_inline.backend_inline, which is a non-GUI backend, so cannot show the figure.
  fig.show()
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_12_1.png" /></p>
</div>
</div>
<div class="section" id="extract-single-cell-expression-values">
<h3>Extract Single-Cell Expression Values<a class="headerlink" href="#extract-single-cell-expression-values" title="Permalink to this headline">¶</a></h3>
<p>Based on the cellmask we can extract sc protein expression values from the image.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">expr</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;cellmasks&#39;</span><span class="p">]</span>

<span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">ids</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># extract single-cell expression values for each layer in the image</span>
<span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">[:,</span> <span class="n">mask</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># add single cell expression values to spatialOmics instance</span>
<span class="n">so</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
<span class="n">so</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3066/3066 [00:03&lt;00:00, 779.03it/s]
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>42</th>
      <th>43</th>
      <th>44</th>
      <th>45</th>
      <th>46</th>
      <th>47</th>
      <th>48</th>
      <th>49</th>
      <th>50</th>
      <th>51</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>504.166809</td>
      <td>2.789689</td>
      <td>0.932818</td>
      <td>5.546103</td>
      <td>4.836011</td>
      <td>7.478273</td>
      <td>13.754079</td>
      <td>9.304479</td>
      <td>11.435987</td>
      <td>1.101779</td>
      <td>...</td>
      <td>0.114558</td>
      <td>0.922130</td>
      <td>0.460403</td>
      <td>11.155493</td>
      <td>0.821286</td>
      <td>7.141858</td>
      <td>13.127857</td>
      <td>4.487766</td>
      <td>0.916052</td>
      <td>0.027065</td>
    </tr>
    <tr>
      <th>2</th>
      <td>505.758942</td>
      <td>2.674268</td>
      <td>0.773134</td>
      <td>4.117366</td>
      <td>4.382695</td>
      <td>5.827538</td>
      <td>10.489146</td>
      <td>8.184184</td>
      <td>6.676378</td>
      <td>0.500451</td>
      <td>...</td>
      <td>0.069695</td>
      <td>1.408488</td>
      <td>0.940549</td>
      <td>28.769440</td>
      <td>1.303585</td>
      <td>2.372439</td>
      <td>4.156317</td>
      <td>4.631183</td>
      <td>0.823171</td>
      <td>0.038183</td>
    </tr>
    <tr>
      <th>3</th>
      <td>508.826782</td>
      <td>1.467071</td>
      <td>0.430452</td>
      <td>3.453262</td>
      <td>3.192524</td>
      <td>4.715620</td>
      <td>8.948931</td>
      <td>6.917524</td>
      <td>5.500190</td>
      <td>0.650714</td>
      <td>...</td>
      <td>0.087429</td>
      <td>0.856952</td>
      <td>0.399071</td>
      <td>21.614906</td>
      <td>1.032905</td>
      <td>1.630524</td>
      <td>3.740691</td>
      <td>4.537024</td>
      <td>0.664929</td>
      <td>0.084000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>504.302216</td>
      <td>1.514519</td>
      <td>0.465135</td>
      <td>2.714404</td>
      <td>2.464943</td>
      <td>3.109519</td>
      <td>6.833097</td>
      <td>4.575481</td>
      <td>5.994712</td>
      <td>0.426192</td>
      <td>...</td>
      <td>0.057692</td>
      <td>0.465808</td>
      <td>0.416808</td>
      <td>13.019441</td>
      <td>0.625423</td>
      <td>1.114288</td>
      <td>2.582231</td>
      <td>4.727558</td>
      <td>0.812923</td>
      <td>0.148673</td>
    </tr>
    <tr>
      <th>5</th>
      <td>501.418091</td>
      <td>1.511736</td>
      <td>0.669417</td>
      <td>2.982694</td>
      <td>3.212319</td>
      <td>4.436403</td>
      <td>8.498236</td>
      <td>5.890807</td>
      <td>4.390930</td>
      <td>0.360083</td>
      <td>...</td>
      <td>0.069625</td>
      <td>0.406875</td>
      <td>0.000000</td>
      <td>0.066417</td>
      <td>0.702208</td>
      <td>1.957056</td>
      <td>3.781848</td>
      <td>4.303611</td>
      <td>0.862278</td>
      <td>0.105028</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3064</th>
      <td>505.311401</td>
      <td>1.847369</td>
      <td>0.613946</td>
      <td>3.214667</td>
      <td>2.686189</td>
      <td>3.890982</td>
      <td>7.952199</td>
      <td>5.741549</td>
      <td>6.344487</td>
      <td>0.405703</td>
      <td>...</td>
      <td>0.112162</td>
      <td>2.999352</td>
      <td>0.472649</td>
      <td>14.226991</td>
      <td>0.971306</td>
      <td>1.405333</td>
      <td>2.625270</td>
      <td>4.385936</td>
      <td>0.855937</td>
      <td>0.101784</td>
    </tr>
    <tr>
      <th>3065</th>
      <td>504.140137</td>
      <td>1.848185</td>
      <td>0.504827</td>
      <td>3.142593</td>
      <td>3.033320</td>
      <td>4.162964</td>
      <td>8.994964</td>
      <td>6.016098</td>
      <td>6.993988</td>
      <td>0.437247</td>
      <td>...</td>
      <td>0.155000</td>
      <td>1.422000</td>
      <td>0.292173</td>
      <td>11.051740</td>
      <td>1.097259</td>
      <td>1.936333</td>
      <td>3.482408</td>
      <td>4.358284</td>
      <td>0.763556</td>
      <td>0.084457</td>
    </tr>
    <tr>
      <th>3066</th>
      <td>510.190491</td>
      <td>1.862593</td>
      <td>0.624062</td>
      <td>4.128098</td>
      <td>3.428827</td>
      <td>4.350506</td>
      <td>9.958580</td>
      <td>6.790135</td>
      <td>9.688334</td>
      <td>0.733333</td>
      <td>...</td>
      <td>0.078691</td>
      <td>0.388420</td>
      <td>0.017420</td>
      <td>0.321136</td>
      <td>0.304716</td>
      <td>4.284889</td>
      <td>8.294691</td>
      <td>4.289370</td>
      <td>0.687062</td>
      <td>0.037037</td>
    </tr>
    <tr>
      <th>3067</th>
      <td>508.075317</td>
      <td>1.531667</td>
      <td>0.329550</td>
      <td>2.540484</td>
      <td>2.060367</td>
      <td>3.620867</td>
      <td>6.987517</td>
      <td>4.659233</td>
      <td>10.906000</td>
      <td>0.753383</td>
      <td>...</td>
      <td>0.059033</td>
      <td>0.350483</td>
      <td>0.111883</td>
      <td>1.587350</td>
      <td>0.468950</td>
      <td>2.887600</td>
      <td>5.298084</td>
      <td>4.096633</td>
      <td>1.036050</td>
      <td>0.033333</td>
    </tr>
    <tr>
      <th>3068</th>
      <td>505.771240</td>
      <td>3.545152</td>
      <td>1.213667</td>
      <td>7.365060</td>
      <td>7.081666</td>
      <td>8.808517</td>
      <td>17.917515</td>
      <td>12.926970</td>
      <td>9.014727</td>
      <td>0.700152</td>
      <td>...</td>
      <td>0.461303</td>
      <td>0.514970</td>
      <td>0.000000</td>
      <td>0.841606</td>
      <td>0.417091</td>
      <td>3.045879</td>
      <td>4.926606</td>
      <td>4.412212</td>
      <td>1.013667</td>
      <td>0.072242</td>
    </tr>
  </tbody>
</table>
<p>3066 rows × 52 columns</p>
</div>
</div>
</div>
<div class="section" id="load-pre-processed-spatialomics">
<h2>Load Pre-processed SpatialOmics<a class="headerlink" href="#load-pre-processed-spatialomics" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">athena</span> <span class="k">as</span> <span class="nn">ath</span>
<span class="n">so</span> <span class="o">=</span> <span class="n">ath</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">imc</span><span class="p">()</span> 
<span class="n">so</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>warning: to get the latest version of this dataset use `so = sh.dataset.imc(force_download=True)`


100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 11.1G/11.1G [39:37&lt;00:00, 5.00MB/s]
INFO:numexpr.utils:NumExpr defaulting to 8 threads.






SpatialOmics object with n_obs 395769
    X: 347, (10, 3671) x (34, 34)
    spl: 347, [&#39;pid&#39;, &#39;location&#39;, &#39;grade&#39;, &#39;tumor_type&#39;, &#39;tumor_size&#39;, &#39;gender&#39;, &#39;menopausal&#39;, &#39;PTNM_M&#39;, &#39;age&#39;, &#39;Patientstatus&#39;, &#39;treatment&#39;, &#39;PTNM_T&#39;, &#39;DiseaseStage&#39;, &#39;PTNM_N&#39;, &#39;AllSamplesSVSp4.Array&#39;, &#39;TMALocation&#39;, &#39;TMAxlocation&#39;, &#39;yLocation&#39;, &#39;DonorBlocklabel&#39;, &#39;diseasestatus&#39;, &#39;TMABlocklabel&#39;, &#39;UBTMAlocation&#39;, &#39;SupplierPatientID&#39;, &#39;Yearofsamplecollection&#39;, &#39;PrimarySite&#39;, &#39;histology&#39;, &#39;PTNM_Radicality&#39;, &#39;Lymphaticinvasion&#39;, &#39;Venousinvasion&#39;, &#39;ERStatus&#39;, &#39;PRStatus&#39;, &#39;HER2Status&#39;, &#39;Pre-surgeryTx&#39;, &#39;Post-surgeryTx&#39;, &#39;Tag&#39;, &#39;Ptdiagnosis&#39;, &#39;DFSmonth&#39;, &#39;OSmonth&#39;, &#39;Comment&#39;, &#39;ER+DuctalCa&#39;, &#39;TripleNegDuctal&#39;, &#39;hormonesensitive&#39;, &#39;hormonerefractory&#39;, &#39;hormoneresistantaftersenstive&#39;, &#39;Fulvestran&#39;, &#39;microinvasion&#39;, &#39;I_plus_neg&#39;, &#39;SN&#39;, &#39;MIC&#39;, &#39;Count_Cells&#39;, &#39;Height_FullStack&#39;, &#39;Width_FullStack&#39;, &#39;area&#39;, &#39;Subtype&#39;, &#39;HER2&#39;, &#39;ER&#39;, &#39;PR&#39;, &#39;clinical_type&#39;]
    obs: 347, {&#39;cell_type&#39;, &#39;CellId&#39;, &#39;id&#39;, &#39;meta_label&#39;, &#39;core&#39;, &#39;phenograph_cluster&#39;, &#39;meta_id&#39;, &#39;cell_type_id&#39;}
    var: 347, {&#39;channel&#39;, &#39;metal_tag&#39;, &#39;full_target_name&#39;, &#39;target&#39;, &#39;fullstack_index&#39;, &#39;feature_type&#39;}
    G: 7, {&#39;radius&#39;, &#39;contact&#39;, &#39;knn&#39;}
    masks: 347, {&#39;cellmasks&#39;}
    images: 347
</pre></div>
</div>
</div>
<div class="section" id="load-pre-processed-anndata-datasets">
<h2>Load Pre-processed AnnData-Datasets<a class="headerlink" href="#load-pre-processed-anndata-datasets" title="Permalink to this headline">¶</a></h2>
<div class="section" id="imc-data">
<h3>IMC Data<a class="headerlink" href="#imc-data" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">squidpy</span> <span class="k">as</span> <span class="nn">sq</span>
<span class="kn">from</span> <span class="nn">spatialOmics</span> <span class="kn">import</span> <span class="n">SpatialOmics</span>
<span class="kn">import</span> <span class="nn">athena</span> <span class="k">as</span> <span class="nn">ath</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imc</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">imc</span><span class="p">()</span>
<span class="n">so</span> <span class="o">=</span> <span class="n">SpatialOmics</span><span class="o">.</span><span class="n">from_annData</span><span class="p">(</span><span class="n">imc</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imc</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 4668 × 34
    obs: &#39;cell type&#39;, &#39;sample_id&#39;
    uns: &#39;cell type_colors&#39;
    obsm: &#39;spatial&#39;
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">so</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SpatialOmics object with n_obs 4668
    X: 1, (4668, 4668) x (34, 34)
    spl: 1, []
    obs: 1, {&#39;x&#39;, &#39;sample_id&#39;, &#39;cell type&#39;, &#39;y&#39;}
    var: 1, set()
    G: 0, set()
    masks: 0, set()
    images: 0
</pre></div>
</div>
<p>Here we convert <code class="docutils literal notranslate"><span class="pre">str</span></code> data types to numeric representations and migrate the colormaps</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">hex2color</span>
<span class="c1"># we have some overhead here as we need to convert to numeric types for the ATHENA framework</span>
<span class="n">spl</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">spl</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cell type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ngroup</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

<span class="c1"># generate colormap</span>
<span class="n">labs</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)[[</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cell type&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="n">hex2color</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">imc</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cell type_colors&#39;</span><span class="p">]])</span>
<span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmaps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">:</span><span class="n">cmap</span><span class="p">})</span>
<span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmap_labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">:</span> <span class="n">labs</span><span class="p">[</span><span class="s1">&#39;cell type&#39;</span><span class="p">]})</span>
</pre></div>
</div>
<p>Compute a neighborhood graph and the shannon index for each observation</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># graph building, metrics</span>
<span class="n">ath</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">build_graph</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">mask_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ath</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">shannon</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Plot the sample with squidpy and ATHENA</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">imc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cell type&quot;</span><span class="p">,</span> <span class="n">spot_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;shannon_cell_type_id_knn&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1"># double click on the figure to enlarge in a jupyter noteboook</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/var/folders/kp/m1glkk8n16x4sszl9c8x90zc0000kp/T/ipykernel_77843/2910317332.py:6: UserWarning: Matplotlib is currently using module://matplotlib_inline.backend_inline, which is a non-GUI backend, so cannot show the figure.
  fig.show() # double click on the figure to enlarge in a jupyter noteboook
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_28_1.png" /></p>
</div>
<div class="section" id="fish-dataset">
<h3>Fish Dataset<a class="headerlink" href="#fish-dataset" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fish</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">seqfish</span><span class="p">()</span>
<span class="c1"># plot AnnData</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">fish</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;celltype_mapped_refined&quot;</span><span class="p">,</span> <span class="n">spot_size</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_30_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">so</span> <span class="o">=</span> <span class="n">SpatialOmics</span><span class="o">.</span><span class="n">from_annData</span><span class="p">(</span><span class="n">fish</span><span class="p">)</span>
<span class="n">spl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">so</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SpatialOmics object with n_obs 19416
    X: 1, (19416, 19416) x (351, 351)
    spl: 1, []
    obs: 1, {&#39;x&#39;, &#39;y&#39;, &#39;celltype_mapped_refined&#39;, &#39;sample_id&#39;, &#39;Area&#39;}
    var: 1, set()
    G: 0, set()
    masks: 0, set()
    images: 0
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># we have some overhead here as we need to convert to numeric types for our framework and migrate colormaps</span>
<span class="n">col_uns_name</span> <span class="o">=</span> <span class="s1">&#39;celltype_mapped_refined&#39;</span>
<span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">col_uns_name</span><span class="p">)</span><span class="o">.</span><span class="n">ngroup</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

<span class="c1"># generate colormap</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="n">labs</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)[[</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">,</span> <span class="n">col_uns_name</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="n">hex2color</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fish</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">col_uns_name</span><span class="o">+</span><span class="s1">&#39;_colors&#39;</span><span class="p">]])</span>
<span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmaps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">:</span><span class="n">cmap</span><span class="p">})</span>
<span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmap_labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">:</span> <span class="n">labs</span><span class="p">[</span><span class="n">col_uns_name</span><span class="p">]})</span>
<span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmaps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">plasma</span><span class="p">})</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># graph building, metrics, plot</span>
<span class="n">ath</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">build_graph</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">mask_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ath</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">shannon</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="c1"># eges=True might take a while since we have so many data points</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;shannon_cell_type_id_knn&#39;</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_34_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># neighborhood enrichment squidpy</span>
<span class="n">sq</span><span class="o">.</span><span class="n">gr</span><span class="o">.</span><span class="n">spatial_neighbors</span><span class="p">(</span><span class="n">fish</span><span class="p">,</span> <span class="n">coord_type</span><span class="o">=</span><span class="s2">&quot;generic&quot;</span><span class="p">)</span>
<span class="n">sq</span><span class="o">.</span><span class="n">gr</span><span class="o">.</span><span class="n">nhood_enrichment</span><span class="p">(</span><span class="n">fish</span><span class="p">,</span> <span class="n">cluster_key</span><span class="o">=</span><span class="s2">&quot;celltype_mapped_refined&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/usr/local/Caskroom/miniconda/base/envs/athena-dev/lib/python3.8/site-packages/tqdm/auto.py:22: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1000/1000 [00:11&lt;00:00, 84.02/s]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># neighborhood enrichment ATHENA, mode = observation</span>
<span class="n">ath</span><span class="o">.</span><span class="n">neigh</span><span class="o">.</span><span class="n">interactions</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="s1">&#39;cell_type_id&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;proportion&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># neighborhood enrichment ATHENA, mode = diff</span>

<span class="c1"># the first time, this takes up to 5min to compute the permutations, permutations are cached.</span>
<span class="n">ath</span><span class="o">.</span><span class="n">neigh</span><span class="o">.</span><span class="n">interactions</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="s1">&#39;cell_type_id&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;proportion&#39;</span><span class="p">,</span> <span class="n">prediction_type</span><span class="o">=</span><span class="s1">&#39;diff&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>INFO:root:generate h0 for spl_0, graph type knn and mode proportion and attribute cell_type_id


Wed Jun 29 16:28:29 2022: 10/100, duration: 3.90) sec
Wed Jun 29 16:29:07 2022: 20/100, duration: 3.84) sec
Wed Jun 29 16:29:45 2022: 30/100, duration: 3.83) sec
Wed Jun 29 16:30:31 2022: 40/100, duration: 4.01) sec
Wed Jun 29 16:31:08 2022: 50/100, duration: 3.96) sec
Wed Jun 29 16:31:46 2022: 60/100, duration: 3.92) sec
Wed Jun 29 16:32:23 2022: 70/100, duration: 3.89) sec
Wed Jun 29 16:32:59 2022: 80/100, duration: 3.86) sec
Wed Jun 29 16:33:36 2022: 90/100, duration: 3.84) sec
Wed Jun 29 16:34:13 2022: 100/100, duration: 3.83) sec
Wed Jun 29 16:34:13 2022: Finished, duration: 6.38 min (3.83sec/it)
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">sq</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">nhood_enrichment</span><span class="p">(</span><span class="n">fish</span><span class="p">,</span> <span class="n">cluster_key</span><span class="o">=</span><span class="s2">&quot;celltype_mapped_refined&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ward&quot;</span><span class="p">)</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">interactions</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="s1">&#39;cell_type_id&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;proportion&#39;</span><span class="p">,</span> <span class="n">prediction_type</span><span class="o">=</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">interactions</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="s1">&#39;cell_type_id&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;proportion&#39;</span><span class="p">,</span> <span class="n">prediction_type</span><span class="o">=</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># re-label y-axis </span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span><span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">]):</span>
    <span class="n">ylab</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ymajorticklabels</span><span class="p">()</span>
    <span class="n">newlab</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">ylab</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmap_labels&#39;</span><span class="p">][</span><span class="s1">&#39;cell_type_id&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">lab</span><span class="o">.</span><span class="n">get_text</span><span class="p">())]</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;,</span><span class="si">{</span><span class="n">lab</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">newlab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">newlab</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/var/folders/kp/m1glkk8n16x4sszl9c8x90zc0000kp/T/ipykernel_77843/1980039856.py:16: UserWarning: Matplotlib is currently using module://matplotlib_inline.backend_inline, which is a non-GUI backend, so cannot show the figure.
  fig.show()
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_38_1.png" /></p>
<p><img alt="png" src="../_images/introduction-spatialOmics_38_2.png" /></p>
</div>
<div class="section" id="visium-fluorescence-data">
<h3>Visium Fluorescence Data<a class="headerlink" href="#visium-fluorescence-data" title="Permalink to this headline">¶</a></h3>
<p>Load the data and process it according to the <a class="reference external" href="https://squidpy.readthedocs.io/en/stable/auto_tutorials/tutorial_visium_fluo.html#sphx-glr-auto-tutorials-tutorial-visium-fluo-py">squidpy tutorial</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">visium</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">visium_fluo_adata_crop</span><span class="p">()</span>
<span class="n">visium_img</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">visium_fluo_image_crop</span><span class="p">()</span>
<span class="n">sq</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">visium_img</span><span class="p">,</span><span class="n">layer</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;smooth&quot;</span><span class="p">)</span>
<span class="n">sq</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">visium_img</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s2">&quot;image_smooth&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;watershed&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># plot AnnData</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">visium</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">)</span>

<span class="c1"># convert to SpatialOmics</span>
<span class="n">so</span> <span class="o">=</span> <span class="n">SpatialOmics</span><span class="o">.</span><span class="n">from_annData</span><span class="p">(</span><span class="n">visium</span><span class="p">,</span> <span class="n">img_container</span><span class="o">=</span><span class="n">visium_img</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_40_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># we have some overhead here as we need to convert to numeric types for our framework</span>
<span class="n">col_uns_name</span> <span class="o">=</span> <span class="s1">&#39;cluster&#39;</span>
<span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">col_uns_name</span><span class="p">)</span><span class="o">.</span><span class="n">ngroup</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

<span class="c1"># generate colormap</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="n">labs</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)[[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">,</span> <span class="n">col_uns_name</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="n">hex2color</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visium</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">col_uns_name</span><span class="o">+</span><span class="s1">&#39;_colors&#39;</span><span class="p">]])</span>
<span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmaps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">:</span><span class="n">cmap</span><span class="p">})</span>
<span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmap_labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">:</span> <span class="n">labs</span><span class="p">[</span><span class="n">col_uns_name</span><span class="p">]})</span>
<span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmaps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">plasma</span><span class="p">})</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># graph building, metrics, plot</span>
<span class="n">ath</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">build_graph</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">mask_key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ath</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">shannon</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;shannon_cluster_id_knn&#39;</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_42_0.png" /></p>
</div>
<div class="section" id="visium-fluorescence-data-alternative-processing-based-on-image-segmentation">
<h3>Visium Fluorescence Data - Alternative Processing based on Image Segmentation<a class="headerlink" href="#visium-fluorescence-data-alternative-processing-based-on-image-segmentation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="load-data">
<h4>Load Data<a class="headerlink" href="#load-data" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># we start again from the visium data set</span>
<span class="n">so</span> <span class="o">=</span> <span class="n">SpatialOmics</span><span class="o">.</span><span class="n">from_annData</span><span class="p">(</span><span class="n">visium</span><span class="p">,</span> <span class="n">img_container</span><span class="o">=</span><span class="n">visium_img</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="analyse-image-segmentation">
<h4>Analyse Image Segmentation<a class="headerlink" href="#analyse-image-segmentation" title="Permalink to this headline">¶</a></h4>
<p>In the upper left corner there are some segmentation artefacts. We simply remove them by setting the segmentation mask to 0 in this corner.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># remove segmentation mask artefacts</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;segmented_watershed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[:</span><span class="mi">1000</span><span class="p">,</span> <span class="p">:</span><span class="mi">1000</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/var/folders/kp/m1glkk8n16x4sszl9c8x90zc0000kp/T/ipykernel_77843/830048520.py:7: UserWarning: Matplotlib is currently using module://matplotlib_inline.backend_inline, which is a non-GUI backend, so cannot show the figure.
  fig.show()
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_47_1.png" /></p>
<p>In a next step we proceed with a very simple processing of the segmentation mask. First we analyse the area
distribution of the different mask. In the histogram we see that the area of the masks is in general &lt; 2500. Furhtermore, we color each pixle in the image according to the size of the mask it belongs to. We can observe that in the Dentate region the segmentation did not work as desired and we have quite large masks there.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># area of segmentations</span>
<span class="n">area</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">[</span><span class="n">area</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># color pixle according to the size of the cell they belong to</span>
<span class="c1"># segmentation is not good in Dentate region</span>
<span class="n">mapping</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
<span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_49_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="c1"># determine quantile values and show distributions of masks smaller than the .995 quantile</span>
<span class="n">q995</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">.995</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">q995</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># highlight small objects</span>
<span class="n">small_objs</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">area</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)]</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">tmp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">small_objs</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># highlight the environment of such a object</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">28662</span><span class="p">)</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">pad</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">xmin</span><span class="o">-</span><span class="n">pad</span><span class="p">:</span><span class="n">xmax</span><span class="o">+</span><span class="n">pad</span><span class="p">,</span> <span class="n">ymin</span><span class="o">-</span><span class="n">pad</span><span class="p">:</span><span class="n">ymax</span><span class="o">+</span><span class="n">pad</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7fa499dbc970&gt;
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_50_1.png" /></p>
<p>Based on the observations of the previous processing and visualisation steps we remove masks very small or very large
mask (<code class="docutils literal notranslate"><span class="pre">area</span> <span class="pre">&gt;</span> <span class="pre">q995</span> <span class="pre">|</span> <span class="pre">area</span> <span class="pre">&lt;</span> <span class="pre">100</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># based on previous inspection discard every segmentation &lt; 100 and &gt;q995</span>
<span class="n">excl</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">area</span> <span class="o">&gt;</span> <span class="n">q995</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">area</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)]</span>
<span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">excl</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">so</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;cellmasks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of masks after filtering: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;segmented_watershed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;cellmasks&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;raw segmentation masks&#39;</span><span class="p">),</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;filtered segmentation masks&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span><span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Number of masks after filtering: 16200


/var/folders/kp/m1glkk8n16x4sszl9c8x90zc0000kp/T/ipykernel_77843/445481155.py:11: UserWarning: Matplotlib is currently using module://matplotlib_inline.backend_inline, which is a non-GUI backend, so cannot show the figure.
  fig.tight_layout();fig.show()
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_52_2.png" /></p>
</div>
<div class="section" id="extraction-of-image-features-for-each-segmentation-mask">
<h4>Extraction of Image Features for each Segmentation Mask<a class="headerlink" href="#extraction-of-image-features-for-each-segmentation-mask" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract image featuers for each object</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">expr</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># get rid of the z-dimension</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;cellmasks&#39;</span><span class="p">]</span>

<span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">ids</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># process a random sample due to computation time</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># extract single-cell expression values, this takes 40 minutes!</span>
<span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># summary statistic used across all pixels: mean</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 100/100 [00:18&lt;00:00,  5.35it/s]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct SpatialOmics</span>
<span class="n">so</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
<span class="n">so</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">so</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="c1"># compute cell-graph based on segmentation mask</span>
<span class="n">ath</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">build_graph</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>

<span class="c1"># construct obs</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">spl</span><span class="p">][</span><span class="s1">&#39;knn&#39;</span><span class="p">]</span>
<span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
<span class="n">so</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="s1">&#39;channel&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">so</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">])</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">extract_centroids</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">)</span>
<span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">spl</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>  <span class="c1"># only keep ids for which we computed the features</span>

<span class="c1"># update default colormap</span>
<span class="n">so</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;cmaps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">plasma</span><span class="p">})</span>

<span class="n">so</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SpatialOmics object with n_obs 100
    X: 1, (100, 100) x (3, 3)
    spl: 1, []
    obs: 1, {&#39;x&#39;, &#39;y&#39;}
    var: 1, {&#39;channels&#39;}
    G: 1, {&#39;knn&#39;}
    masks: 1, {&#39;cellmasks&#39;, &#39;segmented_watershed&#39;}
    images: 1
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot original image, scatter and masks of channel0</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">700</span><span class="p">)</span>
<span class="n">visium_img</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ath</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">spl</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;channel0&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># this does not run if features were extracted for only a subset of ids</span>
<span class="c1"># ath.pl.spatial(so, spl, attr=&#39;channel0&#39;, mode=&#39;mask&#39;, ax=axs[2], background_color=&#39;black&#39;)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/var/folders/kp/m1glkk8n16x4sszl9c8x90zc0000kp/T/ipykernel_77843/4282301744.py:9: UserWarning: Matplotlib is currently using module://matplotlib_inline.backend_inline, which is a non-GUI backend, so cannot show the figure.
  fig.show()
</pre></div>
</div>
<p><img alt="png" src="../_images/introduction-spatialOmics_56_1.png" /></p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../api_overview.html" class="btn btn-neutral float-right" title="API Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="tutorial.html" class="btn btn-neutral float-left" title="Tutorial on Imaging Mass Cytometry data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright IBM Corp. 2021.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>